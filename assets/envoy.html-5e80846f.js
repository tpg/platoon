import{_ as o,r as p,o as i,c as l,a as n,b as s,d as a,e as t}from"./app-e92ff216.js";const c={},r=t(`<p>Platoon is really just a wrapper around Envoy. You could do everything that Platoon does using Envoy alone. However, Platoon is designed to make your life just a little bit easier. Envoy is fantastic and is really not all that complicated. Getting zero-downtime deployments right can be a little tricky as there&#39;s a bunch of steps to get through, so this is where Platoon is really useful.</p><h2 id="the-script" tabindex="-1"><a class="header-anchor" href="#the-script" aria-hidden="true">#</a> The script</h2><p>Since Platoon just wraps Laravel Envoy, there is a default Envoy script at it&#39;s heart. If you feel the need to modify the script, you can publish the Envoy script with:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>php ./artisan platoon:plublish <span class="token parameter variable">--envoy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>or...</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>php ./artisan vendor:publish <span class="token parameter variable">--tag</span><span class="token operator">=</span>platoon-envoy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,6),d=n("code",null,"Envoy.blade.php",-1),u={href:"https://laravel.com/docs/envoy",target:"_blank",rel:"noopener noreferrer"},h={href:"/reference/config.html#hooks",target:"_blank",rel:"noopener noreferrer"},v=t(`<p>The Envoy script is broken up into the separate Platoon tasks (build, install, composer, etc...), and are run in sequence using the <code>deploy</code> story:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token function">story</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;deploy&#39;</span><span class="token punctuation">)</span>
    build
    install
    prep
    composer
    dependencies
    assets
    database
    live
    cleanup
    finish
@endstory
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can add or remove tasks from the story as you need to. For example, let&#39;s say you wanted to add a task that reloaded the Supervisor configuration, and you wanted to run this BEFORE the cleanup task. Add a new task block just above this story block like this:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token function">task</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;supervisor&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;on&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;live&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

supervisorctl reload

@endtask
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now update the story block:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token function">story</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;deploy&#39;</span><span class="token punctuation">)</span>
    build
    install
    prep
    composer
    dependencies
    assets
    database
    live
    supervisor
    cleanup
    finish
@endstory
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When creating new tasks, you can choose to run the task either on the local environment (where Platoon is being run) or on the remote server. Our new <code>supervisor</code> task will run on the server by specifying <code>[&#39;on&#39; =&gt; &#39;live&#39;]</code>. To run the task locally, you could change this to <code>[&#39;on&#39; =&gt; &#39;local&#39;]</code>.</p><h2 id="envoy-helper" tabindex="-1"><a class="header-anchor" href="#envoy-helper" aria-hidden="true">#</a> Envoy helper</h2><p>Platoon provides a simple helper class for use in the Envoy script. If the script provided by Platoon isn&#39;t to your liking and you want to build your own script, you can still use the Platoon Envoy helper in your own scripts. You can reference the Platoon provided script for ideas on how the helper can be used.</p><p>At the very top of the script you should find the <code>@setup</code> block which looks something like this:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token keyword">include</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;./vendor/autoload.php&#39;</span><span class="token punctuation">)</span>

@<span class="token class-name type-declaration">setup</span>

<span class="token variable">$helper</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">TPG<span class="token punctuation">\\</span>Platoon<span class="token punctuation">\\</span>Helpers<span class="token punctuation">\\</span>Envoy</span><span class="token punctuation">;</span>

<span class="token variable">$release</span> <span class="token operator">=</span> <span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token function">newRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token variable">$server</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@endsetup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To make this work, take note of how the the Composer <code>autoload</code> script is included.</p><div class="custom-container tip"><p class="custom-container-title">Note</p><p>For obvious reasons, Envoy does not boot an entire Laravel application. You will not have access to your actual app or any configuration. To get round this, the Envoy helper imports it&#39;s own configuration only. Anything you place in the <code>platoon.php</code> config file will be accessible through the helper, but that&#39;s it. You won&#39;t have access to stuff inside the <code>app.php</code> config.</p></div><p>You can get hold of any Platoon configuration option through the helper with the <code>config()</code> method. In most cases, you should not need to be grabbing configuration items, but the method is there if you need it:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;targets.common.host&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The first task of the helper is to create a new release by calling <code>$helper-&gt;newRelease()</code>. This will return the name of the directory that will be created inside the <code>releases</code> directory. Since this name is needed a bunch, it&#39;s a good idea to keep a copy of it. Next, the helper also needs to provide the deployment target. The <code>target($server)</code> method returns an instance of <code>Target</code> which in turn provides all the details of the specified target.</p><h3 id="paths" tabindex="-1"><a class="header-anchor" href="#paths" aria-hidden="true">#</a> Paths</h3><p>The <code>paths()</code> method can be used to fetch a fully qualified project path. There are four defined paths: <code>releases</code>, <code>live</code>, <code>storage</code> and <code>.env</code>. You can also get the project root by using the <code>path</code> property on the <code>Target</code> instance.</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">;</span>  <span class="token comment">// Project root: /path/to/application</span>
<span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;releases&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// /path/to/application/releases</span>
<span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;live&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// /path/to/application/live</span>
<span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;storage&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// /path/to/application/storage</span>
<span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;.env&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// /path/to/application/.env</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>paths</code> method also accepts a second parameter as a suffix. This can be useful if you need to get to the deployed release path:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;releases&#39;</span><span class="token punctuation">,</span> <span class="token variable">$release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// /path/to/application/releases/1234567890</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="executables" tabindex="-1"><a class="header-anchor" href="#executables" aria-hidden="true">#</a> Executables</h3><p>Platoon needs to know where the PHP, and Composer binaries are. This is done because it&#39;s not uncommon to find multiple versions of PHP on the same host. These values can be configured per target with the <code>php</code> and <code>composer</code> settings. The <code>Target</code> instance provides these values through the <code>php</code> and <code>composer</code> properties respectively:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token property">php</span><span class="token punctuation">;</span>       <span class="token comment">// Path specified as the \`php\` config</span>
<span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token property">composer</span><span class="token punctuation">;</span>  <span class="token comment">// Path specified as the \`composer\` config</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>However, since Composer would need to be run using the same PHP executable, there is a <code>composer()</code> method that does this for you:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">composer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// /path/to/php /path/to/composer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Likewize, there is an <code>artisan()</code> method that does something similar:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">artisan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// /path/to/php /path/to/application/live/artisan</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">Note</p><p>Note the difference between <code>$target-&gt;composer</code> and <code>$target-&gt;composer()</code>.</p></div><h3 id="assets" tabindex="-1"><a class="header-anchor" href="#assets" aria-hidden="true">#</a> Assets</h3><p>Since assets are always copied into the release directory, the <code>assets()</code> method takes the name of the release returned by the <code>newRelease()</code> method on the helper. The <code>assets</code> method will then alter the assets array to include the full target path.</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">assets</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;54321&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">*</span>
<span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;public/localfile.test&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;public/remotefile.test&#39;</span><span class="token punctuation">]</span>

 becomes<span class="token operator">...</span>

<span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;public/localfile.test&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;/path/to/application/releases/54321/public/remotefile.test&#39;</span><span class="token punctuation">]</span>
<span class="token operator">/</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="hooks" tabindex="-1"><a class="header-anchor" href="#hooks" aria-hidden="true">#</a> Hooks</h3><p>The <code>hooks</code> method will return an array of scripts specified in the target config. The method requires the name of the hook as the only parameter.</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;build&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The <code>hooks</code> method will always return an array of commands, so you&#39;ll need to loop through them in an Envoy script. The script supplied with Platoon does exactly this:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;build&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$step</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token variable">$step</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
@<span class="token keyword">endforeach</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To add hooks to the previous <code>supervisor</code> task, the result could look as follows:</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token function">task</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;supervisor&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;on&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;live&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

supervisorctl reload

@<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$target</span><span class="token operator">-&gt;</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;supervisor&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$step</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token variable">$step</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
@<span class="token keyword">endforeach</span>

@endtask
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,39);function k(g,m){const e=p("ExternalLinkIcon");return i(),l("div",null,[r,n("p",null,[s("This will place an "),d,s(" file at the root of the app. If you're interested in learning more about Envoy (and we strongly encourage you to do so), take a look through the "),n("a",u,[s("official documentation"),a(e)]),s(".")]),n("p",null,[s("You shouldn't really need to publish the Envoy script, and if you're simply trying to add commands to each task, take a look at "),n("a",h,[s("Hooks"),a(e)]),s(" in the config reference. You can add functionality to each step without needing the Envoy script at all.")]),v])}const f=o(c,[["render",k],["__file","envoy.html.vue"]]);export{f as default};
